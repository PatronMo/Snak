<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin: 0; background: #0f0f0f; color: white; font-family: Arial, sans-serif; text-align: center; }
canvas { background: #000; border: 3px solid #00ff66; margin-top: 5px; }
.hidden { display: none; }
.score { font-size: 18px; margin: 4px 0; }
.best { color: gold; transition: transform 0.2s; }
.best.flash { animation: bestFlash 0.4s ease; }
@keyframes bestFlash { 0% { transform: scale(1); color: gold; } 50% { transform: scale(1.3); color: #fff176; } 100% { transform: scale(1); color: gold; } }
.score-pop { position: absolute; color: #00ff66; font-weight: bold; pointer-events: none; animation: pop 0.6s ease-out forwards; }
@keyframes pop { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-25px) scale(1.4); } }
#chatBox { height:200px; overflow-y:auto; background:#111; border:2px solid #00ff66; padding:5px; margin: 10px auto; width:90%; max-width:400px; text-align:left; }
#chatInput { width:65%; padding:5px; }
button { padding:5px 10px; cursor:pointer; }
</style>
</head>

<body>

<h1>üêç Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button onclick="saveUsername()">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>

  <p class="score">
    Score: <strong id="scoreDisplay">0</strong> |
    Best: <strong id="bestDisplay" class="best">0</strong>
  </p>

  <div style="position:relative; display:inline-block;">
    <canvas id="game" width="400" height="400"></canvas>
  </div>

  <p id="deathText" class="hidden">üíÄ You died ‚Äî press <b>SPACE</b> to respawn</p>

  <h3>üèÜ Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <h3>üí¨ Global Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB4VdMiIZIjQahzDEMRa_obzQf1bAm-6TI",
  authDomain: "snake-global-leaderboard.firebaseapp.com",
  projectId: "snake-global-leaderboard",
  storageBucket: "snake-global-leaderboard.firebasestorage.app",
  messagingSenderId: "931881309923",
  appId: "1:931881309923:web:43de09e6cd566b3e2a97d6",
  measurementId: "G-883P0X3S65"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- STORAGE ---------- */
const USER_KEY = "snake_username";
let username = localStorage.getItem(USER_KEY);
let bestLocal = 0;

/* ---------- CANVAS ---------- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

/* ---------- GAME STATE ---------- */
let snake, food, score;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop = null;
let alive = true;

/* ---------- DOM ELEMENTS ---------- */
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");

/* ---------- FIRESTORE FUNCTIONS ---------- */
async function saveScore(username, score) {
  try {
    await addDoc(collection(db, "scores"), { username, score, timestamp: Date.now() });
  } catch (e) { console.error("Error adding score:", e); }
}

async function fetchTopScores() {
  const board = document.getElementById("leaderboard");
  board.innerHTML = "";
  const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
  const querySnapshot = await getDocs(q);
  querySnapshot.forEach(doc => {
    const data = doc.data();
    const li = document.createElement("li");
    li.textContent = `${data.username}: ${data.score}`;
    board.appendChild(li);
  });
}

/* ---------- CHAT ---------- */
function sendMessage() {
  const text = chatInput.value.trim();
  if (!text || !username) return;
  addDoc(collection(db, "chatMessages"), {
    username,
    message: text,
    timestamp: Date.now()
  });
  chatInput.value = "";
}

// Listen to latest 50 messages
const chatQuery = query(collection(db, "chatMessages"), orderBy("timestamp", "asc"), limit(50));
onSnapshot(chatQuery, snapshot => {
  chatBox.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.textContent = `${data.username}: ${data.message}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
});

/* ---------- USERNAME ---------- */
function saveUsername() {
  const input = document.getElementById("usernameInput").value.trim();
  if (!input) return alert("Enter a username");

  localStorage.setItem(USER_KEY, input);
  username = input;
  startGame();
}

/* ---------- START ---------- */
function startGame() {
  document.getElementById("usernameScreen").classList.add("hidden");
  document.getElementById("gameScreen").classList.remove("hidden");
  document.getElementById("playerName").textContent = username;
  document.getElementById("bestDisplay").textContent = bestLocal || 0;

  resetGame();
  fetchTopScores();
}

/* ---------- RESET / RESPAWN ---------- */
function resetGame() {
  snake = [
    { x: 10 * box, y: 10 * box },
    { x: 9 * box,  y: 10 * box },
    { x: 8 * box,  y: 10 * box }
  ];

  direction = "RIGHT";
  nextDirection = "RIGHT";
  score = 0;
  alive = true;
  food = spawnFood();

  document.getElementById("scoreDisplay").textContent = 0;
  document.getElementById("deathText").classList.add("hidden");

  clearInterval(loop);
  loop = setInterval(draw, 70);
}

/* ---------- FOOD ---------- */
function spawnFood() { return { x: Math.floor(Math.random() * 20) * box, y: Math.floor(Math.random() * 20) * box }; }

/* ---------- INPUT ---------- */
document.addEventListener("keydown", e => {
  if (!alive && e.code === "Space") resetGame();
  if (e.key === "ArrowLeft"  && direction !== "RIGHT") nextDirection = "LEFT";
  if (e.key === "ArrowUp"    && direction !== "DOWN")  nextDirection = "UP";
  if (e.key === "ArrowRight" && direction !== "LEFT")  nextDirection = "RIGHT";
  if (e.key === "ArrowDown"  && direction !== "UP")    nextDirection = "DOWN";
});

/* ---------- DRAW ---------- */
function draw() {
  direction = nextDirection;
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  snake.forEach((s, i) => {
    ctx.fillStyle = i === 0 ? "#00ff66" : "#00cc55";
    ctx.fillRect(s.x, s.y, box, box);
  });

  ctx.fillStyle = "red";
  ctx.fillRect(food.x, food.y, box, box);

  let head = { ...snake[0] };
  if (direction === "LEFT") head.x -= box;
  if (direction === "RIGHT") head.x += box;
  if (direction === "UP") head.y -= box;
  if (direction === "DOWN") head.y += box;

  if (head.x < 0 || head.y < 0 || head.x >= canvas.width || head.y >= canvas.height ||
      snake.some(s => s.x === head.x && s.y === head.y)) return gameOver();

  if (head.x === food.x && head.y === food.y) {
    score++;
    document.getElementById("scoreDisplay").textContent = score;
    scorePop(head.x, head.y);

    if (score > bestLocal) {
      bestLocal = score;
      document.getElementById("bestDisplay").textContent = score;
      document.getElementById("bestDisplay").classList.add("flash");
      setTimeout(() => document.getElementById("bestDisplay").classList.remove("flash"), 300);
    }

    food = spawnFood();
  } else {
    snake.pop();
  }

  snake.unshift(head);
}

/* ---------- SCORE POP ---------- */
function scorePop(x, y) {
  const pop = document.createElement("div");
  pop.className = "score-pop";
  pop.textContent = "+1";
  pop.style.left = canvas.offsetLeft + x + "px";
  pop.style.top  = canvas.offsetTop  + y + "px";
  document.body.appendChild(pop);
  setTimeout(() => pop.remove(), 600);
}

/* ---------- GAME OVER ---------- */
function gameOver() {
  alive = false;
  clearInterval(loop);

  if (score > bestLocal) bestLocal = score;
  saveScore(username, score); // save online
  fetchTopScores(); // refresh leaderboard

  document.getElementById("deathText").classList.remove("hidden");
}

/* ---------- AUTO START ---------- */
if (username) startGame();
</script>

</body>
</html>

