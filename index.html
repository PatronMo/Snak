<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0; background:#0f0f0f; color:white; font-family:Arial,sans-serif; text-align:center;}
canvas {background:#000; border:3px solid #00ff66; display:block; margin:10px auto;}
.hidden {display:none;}
.score {font-size:18px; margin:4px 0;}
.best {color:gold;}
#ownerPanel {display:none; margin:10px auto; border:2px solid red; padding:10px; width:90%; max-width:400px; text-align:left; background:#222;}
#madeBy {position:absolute; top:5px; left:5px; color:#00ff66; font-weight:bold;}
#announcementPopup {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#ff0; color:#000; padding:10px 20px; font-weight:bold; border-radius:5px; display:none; z-index:1000;}
#ownerToggleBtn {position:fixed; bottom:10px; right:10px; background:red; color:white; font-weight:bold; border:none; border-radius:5px; padding:10px; cursor:pointer;}
</style>
</head>
<body>

<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<h1>ğŸ Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>
  <p class="score">Score: <strong id="scoreDisplay">0</strong></p>
  <canvas id="game" width="400" height="400"></canvas>
  <p id="deathText" class="hidden">ğŸ’€ You died â€” press <b>SPACE</b> to respawn</p>

  <h3>ğŸ† Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <div id="ownerPanel">
    <h3>ğŸ›  Owner Panel</h3>

    <h4>ğŸ’¯ Adjust Scores</h4>
    <input id="ownerScoreInput" type="number" placeholder="Add Score">
    <button id="setScoreBtn">Add Score</button>

    <h4>ğŸ•¶ Invisibility</h4>
    <input id="customInvisTime" type="number" placeholder="Seconds">
    <button id="toggleInvisibleBtn">Activate</button>

    <h4>ğŸ“Š Global Ability</h4>
    <input id="customAbilityTime" type="number" placeholder="Seconds">
    <button id="activateAbilityBtn">Activate Ability</button>

    <h4>ğŸ¤– Auto-Collect</h4>
    <button id="toggleAutoCollectBtn">Toggle Auto-Collect</button>
  </div>
</div>

<button id="ownerToggleBtn">Ã—</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYOMwhe0SpsEucCwB-cLyiPu6d6GPKWJo",
  authDomain: "snake-game-5205d.firebaseapp.com",
  projectId: "snake-game-5205d",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM
const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");

const ownerScoreInput = document.getElementById("ownerScoreInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const toggleInvisibleBtn = document.getElementById("toggleInvisibleBtn");
const customInvisTime = document.getElementById("customInvisTime");
const activateAbilityBtn = document.getElementById("activateAbilityBtn");
const customAbilityTime = document.getElementById("customAbilityTime");
const toggleAutoCollectBtn = document.getElementById("toggleAutoCollectBtn");

// Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

// Game state
let username = localStorage.getItem("snake_username") || "";
let snake = [];
let food = {};
let score = 0;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop = null;
let alive = true;
let invisible = false;
let abilityActive = false;
let autoCollect = false;
let autoInterval = null;

let owners = ["PatronMo"];

function isOwner(){ return owners.includes(username); }

function showAnnouncement(msg){
  const popup = document.getElementById("announcementPopup");
  popup.textContent = msg;
  popup.style.display="block";
  setTimeout(()=>popup.style.display="none",2500);
}

function spawnFood(){
  return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box};
}

function resetGame(){
  snake = [
    {x:10*box, y:10*box},
    {x:9*box, y:10*box},
    {x:8*box, y:10*box}
  ];
  direction="RIGHT"; nextDirection="RIGHT";
  score = 0;
  alive = true;
  food = spawnFood();
  scoreDisplay.textContent = score;
  deathText.classList.add("hidden");
  clearInterval(loop);
  loop = setInterval(draw,70);
}

// DRAW
function draw(){
  direction=nextDirection;

  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // food
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(food.x+box/2,food.y+box/2,box/2,0,Math.PI*2);
  ctx.fill();

  // snake
  snake.forEach((s,i)=>{
    if(abilityActive){
      ctx.shadowBlur = 15;
      ctx.shadowColor = "#00ffcc";
    } else {
      ctx.shadowBlur = 0;
    }
    ctx.fillStyle=i===0?"#00ff66":"#00cc55";
    ctx.beginPath();
    ctx.arc(s.x+box/2,s.y+box/2,box/2,0,Math.PI*2);
    ctx.fill();
  });

  let head = {...snake[0]};
  if(direction==="LEFT") head.x-=box;
  if(direction==="RIGHT") head.x+=box;
  if(direction==="UP") head.y-=box;
  if(direction==="DOWN") head.y+=box;

  if(!invisible && (
    head.x<0 || head.y<0 ||
    head.x>=canvas.width || head.y>=canvas.height ||
    snake.some(s=>s.x===head.x && s.y===head.y)
  )){
    alive=false;
    clearInterval(loop);
    deathText.classList.remove("hidden");
    return;
  }

  if(head.x===food.x && head.y===food.y){
    score++;
    scoreDisplay.textContent=score;
    snake.unshift(head);
    food=spawnFood();
  } else {
    snake.pop();
    snake.unshift(head);
  }
}

// KEY INPUT
document.addEventListener("keydown", e=>{
  if(!alive && e.code==="Space"){ resetGame(); return; }
  if(e.key==="ArrowLeft" && direction!=="RIGHT") nextDirection="LEFT";
  if(e.key==="ArrowRight" && direction!=="LEFT") nextDirection="RIGHT";
  if(e.key==="ArrowUp" && direction!=="DOWN") nextDirection="UP";
  if(e.key==="ArrowDown" && direction!=="UP") nextDirection="DOWN";
});

// OWNER SCORE â†’ REAL BODY
setScoreBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const val=parseInt(ownerScoreInput.value);
  if(isNaN(val)||val<=0) return;

  score+=val;
  scoreDisplay.textContent=score;

  for(let i=0;i<val;i++){
    const tail = snake[snake.length-1];
    snake.push({...tail});
  }
});

// INVISIBILITY
toggleInvisibleBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const t=parseInt(customInvisTime.value);
  if(isNaN(t)||t<=0) return;
  invisible=true;
  showAnnouncement("Invisible "+t+"s");
  setTimeout(()=>{ invisible=false; }, t*1000);
});

// GLOBAL ABILITY
activateAbilityBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const t=parseInt(customAbilityTime.value);
  if(isNaN(t)||t<=0) return;

  abilityActive=true;
  invisible=true;
  clearInterval(loop);
  loop=setInterval(draw,35);
  showAnnouncement("GLOBAL ABILITY ACTIVE");

  setTimeout(()=>{
    abilityActive=false;
    invisible=false;
    clearInterval(loop);
    loop=setInterval(draw,70);
    showAnnouncement("Ability ended");
  }, t*1000);
});

// SMART AUTO COLLECT
function isSafe(x,y){
  return (
    x>=0 && x<canvas.width &&
    y>=0 && y<canvas.height &&
    !snake.some(s=>s.x===x && s.y===y)
  );
}

function autoMove(){
  if(!alive) return;

  const head = snake[0];
  const moves = [
    {dir:"LEFT", x:head.x-box, y:head.y},
    {dir:"RIGHT", x:head.x+box, y:head.y},
    {dir:"UP", x:head.x, y:head.y-box},
    {dir:"DOWN", x:head.x, y:head.y+box},
  ];

  // safe moves only
  const safeMoves = moves.filter(m=>isSafe(m.x,m.y));
  if(safeMoves.length===0) return;

  // choose closest to food
  safeMoves.sort((a,b)=>{
    const da=Math.abs(a.x-food.x)+Math.abs(a.y-food.y);
    const db=Math.abs(b.x-food.x)+Math.abs(b.y-food.y);
    return da-db;
  });

  nextDirection=safeMoves[0].dir;
}

toggleAutoCollectBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  autoCollect=!autoCollect;
  showAnnouncement("Auto "+(autoCollect?"ON":"OFF"));
  if(autoCollect) autoInterval=setInterval(autoMove,70);
  else clearInterval(autoInterval);
});

// START
startBtn.addEventListener("click", ()=>{
  const val=usernameInput.value.trim();
  if(!val) return;
  username=val;
  localStorage.setItem("snake_username",username);
  usernameScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  playerNameEl.textContent=username;
  resetGame();
});

if(username){
  usernameScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  playerNameEl.textContent=username;
  resetGame();
}

// OWNER PANEL
ownerToggleBtn.addEventListener("click", ()=>{
  if(!isOwner()) return alert("Not owner");
  ownerPanel.style.display = ownerPanel.style.display==="block"?"none":"block";
});

// LEADERBOARD
const leaderboardQuery=query(collection(db,"scores"),orderBy("score","desc"),limit(10));
onSnapshot(leaderboardQuery,snapshot=>{
  leaderboard.innerHTML="";
  snapshot.forEach(doc=>{
    leaderboard.innerHTML+=`<li>${doc.id}: ${doc.data().score}</li>`;
  });
});
</script>
</body>
</html>
