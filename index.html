<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  background:#0f0f0f;
  color:white;
  font-family:Arial,sans-serif;
  text-align:center;
  overflow-y:auto;
}
canvas {
  background:#000;
  border:3px solid #00ff66;
  display:block;
  margin:10px auto;
}
.hidden { display:none; }
.score { font-size:18px; margin:4px 0; }
.best { color:gold; transition:transform 0.2s; }
.best.flash { animation: bestFlash 0.4s ease; }
@keyframes bestFlash { 0% {transform:scale(1); color:gold;} 50% {transform:scale(1.3); color:#fff176;} 100% {transform:scale(1); color:gold;} }
.score-pop { position:absolute; color:#00ff66; font-weight:bold; pointer-events:none; animation:pop 0.6s ease-out forwards; }
@keyframes pop { 0% {opacity:1; transform:translateY(0) scale(1);} 100% {opacity:0; transform:translateY(-25px) scale(1.4);} }

#chatBox {
  max-height:250px;
  overflow-y:auto;
  background:#111;
  border:2px solid #00ff66;
  padding:5px;
  margin:10px auto;
  width:90%;
  max-width:400px;
  text-align:left;
}

#chatInput { width:65%; padding:5px; }
button { padding:5px 10px; cursor:pointer; }

#ownerPanel {
  display:none;
  margin:10px auto;
  border:2px solid red;
  padding:10px;
  width:90%;
  max-width:400px;
  text-align:left;
  background:#222;
}
#madeBy {
  position:absolute;
  top:5px;
  left:5px;
  color:#00ff66;
  font-weight:bold;
}
#announcementPopup {
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:#ff0;
  color:#000;
  padding:10px 20px;
  font-weight:bold;
  border-radius:5px;
  display:none;
  z-index:1000;
}
#ownerToggleBtn {
  position:fixed;
  bottom:10px;
  right:10px;
  background:red;
  color:white;
  font-weight:bold;
  border:none;
  border-radius:5px;
  padding:10px;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<h1>üêç Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>
  <p class="score">Score: <strong id="scoreDisplay">0</strong> | Best: <strong id="bestDisplay" class="best">0</strong></p>

  <canvas id="game" width="400" height="400"></canvas>

  <p id="deathText" class="hidden">üíÄ You died ‚Äî press <b>SPACE</b> to respawn</p>

  <h3>üèÜ Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <h3>üí¨ Global Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button id="chatSendBtn">Send</button>

  <div id="ownerPanel">
    <h3>üõ† Owner Panel</h3>
    <div>
      <h4>üíØ Adjust Scores</h4>
      <input id="ownerPlayerInput" placeholder="Username">
      <input id="ownerScoreInput" type="number" placeholder="Score">
      <button id="setScoreBtn">Set Score</button>
      <button id="deletePlayerBtn">Delete Player</button>
    </div>
    <div>
      <h4>üí¨ Chat Management</h4>
      <button id="clearChatBtn">Clear Chat</button>
      <input id="announcementInput" placeholder="Announcement">
      <button id="sendAnnouncementBtn">Send Announcement</button>
    </div>
  </div>
</div>

<button id="ownerToggleBtn">√ó</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, orderBy, limit, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYOMwhe0SpsEucCwB-cLyiPu6d6GPKWJo",
  authDomain: "snake-game-5205d.firebaseapp.com",
  projectId: "snake-game-5205d",
  storageBucket: "snake-game-5205d.firebasestorage.app",
  messagingSenderId: "669471957796",
  appId: "1:669471957796:web:5d69121f9a74e696fb49b1",
  measurementId: "G-75TJWFLDSK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const bestDisplay = document.getElementById("bestDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");
const ownerPlayerInput = document.getElementById("ownerPlayerInput");
const ownerScoreInput = document.getElementById("ownerScoreInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const deletePlayerBtn = document.getElementById("deletePlayerBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const announcementInput = document.getElementById("announcementInput");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");
const announcementPopup = document.getElementById("announcementPopup");

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

let username = localStorage.getItem("snake_username") || "";
let bestLocal = parseInt(localStorage.getItem("snake_best")) || 0;
let snake, food, score;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop = null;
let alive = true;

const OWNER_USERNAME = "PatronMo";

// Snake
function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }
function scorePop(x,y){ const pop=document.createElement("div"); pop.className="score-pop"; pop.textContent="+1"; pop.style.left=canvas.offsetLeft+x+"px"; pop.style.top=canvas.offsetTop+y+"px"; document.body.appendChild(pop); setTimeout(()=>pop.remove(),600); }
function showAnnouncement(msg){ announcementPopup.textContent=msg; announcementPopup.style.display="block"; setTimeout(()=>announcementPopup.style.display="none",3000); }

// Username
async function saveUsername(){
  const input=usernameInput.value.trim();
  if(!input) return alert("Enter a username");
  username=input; localStorage.setItem("snake_username",username);
  const userDocRef = doc(db,"scores",username);
  const userDoc = await getDoc(userDocRef);
  bestLocal=userDoc.exists()?userDoc.data().score||0:0;
  localStorage.setItem("snake_best",bestLocal);
  startGame();
}

// Owner toggle
ownerToggleBtn.addEventListener("click",()=>{
  if(ownerPanel.style.display==="block"){ ownerPanel.style.display="none"; }
  else{ if(username===OWNER_USERNAME) ownerPanel.style.display="block"; else alert("Only PatronMo can open owner panel"); }
});

// Chat
async function sendMessage(){
  const text=chatInput.value.trim(); if(!text) return;
  await addDoc(collection(db,"chatMessages"),{username,message:text,timestamp:Date.now()});
  chatInput.value=""; chatInput.focus();
}
chatSendBtn.addEventListener("click",sendMessage);
chatInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }
});

// Chat realtime
const chatQuery=query(collection(db,"chatMessages"),orderBy("timestamp","desc"),limit(50));
onSnapshot(chatQuery,snapshot=>{
  const messages=[];
  snapshot.forEach(doc=>messages.push(doc.data()));
  messages.reverse();
  chatBox.innerHTML="";
  messages.forEach(m=>{
    const div=document.createElement("div");
    div.textContent=`${m.username}: ${m.message}`;
    chatBox.appendChild(div);
    if(m.username==="üåü Announcement") showAnnouncement(m.message);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Leaderboard
async function fetchTopScores(){
  leaderboard.innerHTML="";
  const scoresSnapshot = await getDocs(collection(db,"scores"));
  const scoresArray = [];
  scoresSnapshot.forEach(docSnap=>{
    const data=docSnap.data();
    if(data.username && typeof data.score==="number") scoresArray.push({username:data.username,score:data.score});
  });
  scoresArray.sort((a,b)=>b.score - a.score);
  scoresArray.slice(0,10).forEach(s=>{
    const li=document.createElement("li");
    li.textContent=`${s.username}: ${s.score}`;
    leaderboard.appendChild(li);
  });
}

// Snake game
function resetGame(){
  snake=[{x:10*box,y:10*box},{x:9*box,y:10*box},{x:8*box,y:10*box}];
  direction="RIGHT"; nextDirection="RIGHT"; score=0; alive=true;
  food=spawnFood();
  scoreDisplay.textContent=0;
  deathText.classList.add("hidden");
  clearInterval(loop); loop=setInterval(draw,70);
}
function startGame(){
  usernameScreen.classList.add("hidden"); gameScreen.classList.remove("hidden");
  playerNameEl.textContent=username;
  bestDisplay.textContent=bestLocal;
  resetGame();
  fetchTopScores();
}

// Snake movement with arrow keys + WASD, only prevent default outside inputs
document.addEventListener("keydown",e=>{
  const tag = document.activeElement.tagName.toLowerCase();
  const key = e.key.toLowerCase();

  // Only prevent scrolling if not typing in input
  if(tag!=="input" && ["arrowleft","arrowup","arrowright","arrowdown"," ","w","a","s","d"].includes(key)) e.preventDefault();

  if(!alive && e.code==="Space" && tag!=="input") resetGame();

  if(key==="arrowleft" && direction!=="RIGHT") nextDirection="LEFT";
  if(key==="arrowright" && direction!=="LEFT") nextDirection="RIGHT";
  if(key==="arrowup" && direction!=="DOWN") nextDirection="UP";
  if(key==="arrowdown" && direction!=="UP") nextDirection="DOWN";

  if(key==="a" && direction!=="RIGHT") nextDirection="LEFT";
  if(key==="d" && direction!=="LEFT") nextDirection="RIGHT";
  if(key==="w" && direction!=="DOWN") nextDirection="UP";
  if(key==="s" && direction!=="UP") nextDirection="DOWN";
});

function draw(){
  direction=nextDirection;
  ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height);
  snake.forEach((s,i)=>{ ctx.fillStyle=i===0?"#00ff66":"#00cc55"; ctx.fillRect(s.x,s.y,box,box); });
  ctx.fillStyle="red"; ctx.fillRect(food.x,food.y,box,box);
  let head={...snake[0]};
  if(direction==="LEFT") head.x-=box;
  if(direction==="RIGHT") head.x+=box;
  if(direction==="UP") head.y-=box;
  if(direction==="DOWN") head.y+=box;
  if(head.x<0||head.y<0||head.x>=canvas.width||head.y>=canvas.height||snake.some(s=>s.x===head.x&&s.y===head.y)) return gameOver();
  if(head.x===food.x && head.y===food.y){ score++; scoreDisplay.textContent=score; scorePop(head.x,head.y); food=spawnFood();
    if(score>bestLocal){ bestLocal=score; bestDisplay.textContent=bestLocal; bestDisplay.classList.add("flash"); setTimeout(()=>bestDisplay.classList.remove("flash"),300); localStorage.setItem("snake_best",bestLocal);}
  }else snake.pop();
  snake.unshift(head);
}

async function gameOver(){
  alive=false; 
  clearInterval(loop);
  const userDocRef=doc(db,"scores",username);
  const userDoc=await getDoc(userDocRef);
  if(!userDoc.exists() || score>userDoc.data().score){
    await setDoc(userDocRef,{username,score,timestamp:Date.now()});
  }
  fetchTopScores();
  deathText.classList.remove("hidden");
}

// Owner actions
setScoreBtn.addEventListener("click",async()=>{
  const u=ownerPlayerInput.value.trim(); const s=parseInt(ownerScoreInput.value);
  if(!u||isNaN(s)) return alert("Enter username and valid score");
  await setDoc(doc(db,"scores",u),{username:u,score:s,timestamp:Date.now()});
  fetchTopScores();
});
deletePlayerBtn.addEventListener("click",async()=>{
  const u=ownerPlayerInput.value.trim(); if(!u) return alert("Enter username");
  await deleteDoc(doc(db,"scores",u));
  fetchTopScores();
});
clearChatBtn.addEventListener("click",async()=>{
  if(username!==OWNER_USERNAME) return;
  if(!confirm("Weet je zeker dat je alle chatberichten wilt verwijderen?")) return;
  const snapshot=await getDocs(collection(db,"chatMessages"));
  snapshot.forEach(async docSnap=>await deleteDoc(doc(db,"chatMessages",docSnap.id)));
});
sendAnnouncementBtn.addEventListener("click",async()=>{
  const msg=announcementInput.value.trim(); if(!msg) return;
  await addDoc(collection(db,"chatMessages"),{username:"üåü Announcement",message:msg,timestamp:Date.now()});
  announcementInput.value="";
  showAnnouncement(msg);
});

// Start
if(username) startGame();
startBtn.addEventListener("click",saveUsername);

</script>
</body>
</html>
