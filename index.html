<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin:0; padding:0; font-family: 'Segoe UI', sans-serif;
  background:#111; color:#fff; display:flex; justify-content:center; align-items:flex-start; flex-direction:column;
}
#gameContainer { display:flex; justify-content:center; gap:20px; margin-top:20px; flex-wrap:wrap; }
#leftPanel { display:flex; flex-direction:column; align-items:center; }
#rightPanel { display:flex; flex-direction:column; max-width:300px; gap:10px; }
canvas { background:#000; border:2px solid #0f0; border-radius:10px; }
.hidden {display:none;}
#madeBy {color:#0f0; font-weight:bold; margin-bottom:10px;}
#scoreDisplay {font-size:18px; margin:4px 0;}
#deathText {color:#f00; font-weight:bold;}
#announcementPopup {
  position:fixed; top:10px; left:50%; transform:translateX(-50%);
  background:#ff0; color:#000; padding:8px 16px; border-radius:6px; font-weight:bold;
  display:none; z-index:1000;
}
#ownerPanel {
  display:none; background:#222; padding:10px; border-radius:8px; border:2px solid red;
  flex-direction:column; gap:8px;
}
#commandBar { display:flex; gap:5px; }
#commandInput { flex:1; padding:5px 8px; border-radius:5px; border:none; outline:none; }
#commandBtn { padding:5px 10px; border:none; border-radius:5px; background:#0f0; color:#000; cursor:pointer; font-weight:bold; }
button { cursor:pointer; }
</style>
</head>
<body>

<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<div id="gameContainer">
  <div id="leftPanel">
    <canvas id="game" width="400" height="400"></canvas>
    <p>Player: <strong id="playerName"></strong></p>
    <p id="scoreDisplay">Score: 0</p>
    <p id="deathText" class="hidden">ðŸ’€ You died â€” press <b>SPACE</b> to respawn</p>
  </div>

  <div id="rightPanel">
    <h3>Leaderboard</h3>
    <ol id="leaderboard"></ol>

    <div id="commandBar">
      <input id="commandInput" placeholder="Enter command">
      <button id="commandBtn">Go</button>
    </div>

    <div id="ownerPanel">
      <h3>ðŸ›  Owner Panel</h3>
      <input id="ownerScoreInput" type="number" placeholder="Add Score">
      <button id="setScoreBtn">Add Score</button>
      <input id="customInvisTime" type="number" placeholder="Seconds">
      <button id="toggleInvisibleBtn">Activate Invis</button>
      <input id="customAbilityTime" type="number" placeholder="Seconds">
      <button id="activateAbilityBtn">Activate Ability</button>
      <button id="toggleAutoCollectBtn">Toggle Auto-Collect</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYOMwhe0SpsEucCwB-cLyiPu6d6GPKWJo",
  authDomain: "snake-game-5205d.firebaseapp.com",
  projectId: "snake-game-5205d",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const ownerPanel = document.getElementById("ownerPanel");
const announcementPopup = document.getElementById("announcementPopup");

const ownerScoreInput = document.getElementById("ownerScoreInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const toggleInvisibleBtn = document.getElementById("toggleInvisibleBtn");
const customInvisTime = document.getElementById("customInvisTime");
const activateAbilityBtn = document.getElementById("activateAbilityBtn");
const customAbilityTime = document.getElementById("customAbilityTime");
const toggleAutoCollectBtn = document.getElementById("toggleAutoCollectBtn");

const commandInput = document.getElementById("commandInput");
const commandBtn = document.getElementById("commandBtn");

// Game state
const box = 20;
let username = localStorage.getItem("snake_username") || "Player";
let snake = [];
let food = {};
let score = 0;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop = null;
let alive = true;
let invisible = false;
let abilityActive = false;
let autoCollect = false;
let autoInterval = null;
let owners = ["PatronMo"];
function isOwner(){ return owners.includes(username); }

playerNameEl.textContent=username;

function showAnnouncement(msg){
  announcementPopup.textContent=msg;
  announcementPopup.style.display="block";
  setTimeout(()=>announcementPopup.style.display="none",2500);
}

function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }

function resetGame(){
  snake = [
    {x:10*box, y:10*box},
    {x:9*box, y:10*box},
    {x:8*box, y:10*box}
  ];
  direction="RIGHT"; nextDirection="RIGHT";
  score = 0; alive=true; food=spawnFood();
  scoreDisplay.textContent=score;
  deathText.classList.add("hidden");
  clearInterval(loop);
  loop = setInterval(draw,70);
}

// DRAW
function draw(){
  direction=nextDirection;

  ctx.fillStyle="#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // food
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(food.x+box/2,food.y+box/2,box/2,0,Math.PI*2);
  ctx.fill();

  // snake
  snake.forEach((s,i)=>{
    ctx.shadowBlur = abilityActive?5:0;
    ctx.shadowColor="#0ff";
    ctx.fillStyle=i===0?"#0f0":"#0a0";
    ctx.beginPath();
    ctx.arc(s.x+box/2,s.y+box/2,box/2,0,Math.PI*2);
    ctx.fill();
  });

  let head = {...snake[0]};
  if(direction==="LEFT") head.x-=box;
  if(direction==="RIGHT") head.x+=box;
  if(direction==="UP") head.y-=box;
  if(direction==="DOWN") head.y+=box;

  // wrap if invisible
  if(invisible){
    if(head.x<0) head.x=canvas.width-box;
    if(head.x>=canvas.width) head.x=0;
    if(head.y<0) head.y=canvas.height-box;
    if(head.y>=canvas.height) head.y=0;
  }

  // normal collision
  if(!invisible && (head.x<0 || head.y<0 || head.x>=canvas.width || head.y>=canvas.height || snake.some(s=>s.x===head.x && s.y===head.y))){
    alive=false;
    clearInterval(loop);
    deathText.classList.remove("hidden");
    return;
  }

  if(head.x===food.x && head.y===food.y){
    score++; scoreDisplay.textContent=score;
    snake.unshift(head);
    food=spawnFood();
  } else {
    snake.pop(); snake.unshift(head);
  }
}

// KEY INPUT
document.addEventListener("keydown", e=>{
  if(!alive && e.code==="Space"){ resetGame(); return; }
  if(e.key==="ArrowLeft" && direction!=="RIGHT") nextDirection="LEFT";
  if(e.key==="ArrowRight" && direction!=="LEFT") nextDirection="RIGHT";
  if(e.key==="ArrowUp" && direction!=="DOWN") nextDirection="UP";
  if(e.key==="ArrowDown" && direction!=="UP") nextDirection="DOWN";
});

// OWNER FUNCTIONS
setScoreBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const val=parseInt(ownerScoreInput.value);
  if(isNaN(val)||val<=0) return;
  score+=val; scoreDisplay.textContent=score;
  for(let i=0;i<val;i++){ snake.push({...snake[snake.length-1]}); }
});

toggleInvisibleBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const t=parseInt(customInvisTime.value);
  if(isNaN(t)||t<=0) return;
  invisible=true; showAnnouncement("Invisible "+t+"s");
  setTimeout(()=>{ invisible=false; }, t*1000);
});

activateAbilityBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  const t=parseInt(customAbilityTime.value);
  if(isNaN(t)||t<=0) return;
  abilityActive=true; invisible=true;
  clearInterval(loop); loop=setInterval(draw,50);
  showAnnouncement("GLOBAL ABILITY ACTIVE");
  setTimeout(()=>{
    abilityActive=false; invisible=false; clearInterval(loop); loop=setInterval(draw,70);
    showAnnouncement("Ability ended");
  }, t*1000);
});

// MAX AUTO-COLLECT
function getNeighbors(node){
  return [
    {x:node.x-box,y:node.y,dir:"LEFT"},
    {x:node.x+box,y:node.y,dir:"RIGHT"},
    {x:node.x,y:node.y-box,dir:"UP"},
    {x:node.x,y:node.y+box,dir:"DOWN"},
  ];
}
function isSafeFuture(x,y,snakeBody){
  return x>=0 && x<canvas.width && y>=0 && y<canvas.height && !snakeBody.some(s=>s.x===x && s.y===y);
}
function bfsPath(start,target,body){
  const queue=[{x:start.x,y:start.y,path:[]}]; const visited=new Set();
  while(queue.length){
    const node=queue.shift(); const key=node.x+","+node.y;
    if(visited.has(key)) continue; visited.add(key);
    if(node.x===target.x && node.y===target.y) return node.path;
    for(const n of getNeighbors(node)){
      if(isSafeFuture(n.x,n.y,body)) queue.push({x:n.x,y:n.y,path:[...node.path,n.dir]});
    }
  }
  return null;
}
function followTail(){
  const tail=snake[snake.length-1]; return bfsPath(snake[0],tail,snake);
}
function countOpenArea(x,y){
  let count=0; const visited=new Set(); const queue=[{x,y}];
  while(queue.length && count<100){
    const node=queue.shift(); const key=node.x+","+node.y;
    if(visited.has(key)) continue; visited.add(key);
    if(!isSafeFuture(node.x,node.y,snake)) continue; count++;
    for(const n of getNeighbors(node)) queue.push({x:n.x,y:n.y});
  } return count;
}
function autoMove(){
  if(!alive) return;
  let path=bfsPath(snake[0],food,snake);
  if(!path || path.length===0) path=followTail();
  if(!path || path.length===0){
    const head=snake[0]; const moves=getNeighbors(head).filter(m=>isSafeFuture(m.x,m.y,snake));
    if(moves.length){ moves.sort((a,b)=>countOpenArea(b.x,b.y)-countOpenArea(a.x,a.y)); nextDirection=moves[0].dir; return; }
  }
  if(path && path.length) nextDirection=path[0];
}
toggleAutoCollectBtn.addEventListener("click", ()=>{
  if(!isOwner()) return;
  autoCollect=!autoCollect;
  showAnnouncement("Auto "+(autoCollect?"ON":"OFF"));
  if(autoCollect) autoInterval=setInterval(autoMove,60);
  else clearInterval(autoInterval);
});

// COMMAND BAR
function checkCommand(cmd){
  if(cmd==="!DaddioMo"){
    if(!owners.includes(username)) owners.push(username);
    ownerPanel.style.display="flex";
    showAnnouncement("Access Granted");
  }
}
commandBtn.addEventListener("click", ()=>{ checkCommand(commandInput.value.trim()); commandInput.value=""; });
commandInput.addEventListener("keydown", e=>{ if(e.key==="Enter") { checkCommand(commandInput.value.trim()); commandInput.value=""; } });

// INITIAL GAME START
resetGame();

// LEADERBOARD
const leaderboardQuery=query(collection(db,"scores"),orderBy("score","desc"),limit(10));
onSnapshot(leaderboardQuery,snapshot=>{
  leaderboard.innerHTML="";
  snapshot.forEach(doc=>{
    leaderboard.innerHTML+=`<li>${doc.id}: ${doc.data().score}</li>`;
  });
});
</script>
</body>
</html>
