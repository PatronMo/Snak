<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0; background:#0f0f0f; color:white; font-family:Arial,sans-serif; text-align:center; overflow-y:auto;}
canvas {background:#000; border:3px solid #00ff66; display:block; margin:10px auto;}
.hidden {display:none;}
.score {font-size:18px; margin:4px 0;}
#chatBox {max-height:250px; overflow-y:auto; background:#111; border:2px solid #00ff66; padding:5px; margin:10px auto; width:90%; max-width:400px; text-align:left;}
#chatInput {width:65%; padding:5px;}
button {padding:5px 10px; cursor:pointer;}
#ownerPanel {display:none; margin:10px auto; border:2px solid red; padding:10px; width:90%; max-width:400px; text-align:left; background:#222;}
#madeBy {position:absolute; top:5px; left:5px; color:#00ff66; font-weight:bold;}
#announcementPopup {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#ff0; color:#000; padding:10px 20px; font-weight:bold; border-radius:5px; display:none; z-index:1000;}
#ownerToggleBtn {position:fixed; bottom:10px; right:10px; background:red; color:white; font-weight:bold; border:none; border-radius:5px; padding:10px; cursor:pointer;}
#pollArea button {margin:2px;}
#abilityTimerDisplay {margin:5px 0; font-weight:bold; color:#0ff;}
</style>
</head>
<body>
<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<h1>ğŸ Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>
  <p class="score">Score: <strong id="scoreDisplay">0</strong></p>
  <canvas id="game" width="400" height="400"></canvas>
  <p id="deathText" class="hidden">ğŸ’€ You died â€” press <b>SPACE</b> to respawn</p>

  <h3>ğŸ† Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <h3>ğŸ’¬ Global Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button id="chatSendBtn">Send</button>

  <h3>ğŸ“Š Live Poll</h3>
  <div id="pollArea"></div>

  <h3>â± Global Ability</h3>
  <div id="abilityTimerDisplay">Inactive</div>

  <div id="ownerPanel">
    <h3>ğŸ›  Owner Panel</h3>
    <div>
      <h4>ğŸ’¯ Adjust Scores</h4>
      <input id="ownerPlayerInput" placeholder="Username">
      <input id="ownerScoreInput" type="number" placeholder="Score">
      <button id="setScoreBtn">Set Score</button>
      <button id="deletePlayerBtn">Delete Player</button>
    </div>
    <div>
      <h4>ğŸ’¬ Chat Management</h4>
      <button id="clearChatBtn">Clear Chat</button>
      <input id="announcementInput" placeholder="Announcement">
      <button id="sendAnnouncementBtn">Send Announcement</button>
    </div>
    <div>
      <h4>ğŸ‘‘ Owner Management</h4>
      <input id="ownerManageInput" placeholder="Username">
      <button id="giveOwnerBtn">Give Owner</button>
      <button id="removeOwnerBtn">Remove Owner</button>
    </div>
    <div>
      <h4>â³ Timer Function</h4>
      <input id="timerInput" type="number" placeholder="Seconds">
      <input id="timerMessageInput" placeholder="Message">
      <button id="startTimerBtn">Start Timer</button>
    </div>
  </div>
</div>

<button id="ownerToggleBtn">Ã—</button>

<script type="module">
// ---------- FIREBASE ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
const firebaseConfig = { apiKey:"AIzaSyCYOMwhe0SpsEucCwB-cLyiPu6d6GPKWJo", authDomain:"snake-game-5205d.firebaseapp.com", projectId:"snake-game-5205d", storageBucket:"snake-game-5205d.firebasestorage.app", messagingSenderId:"669471957796", appId:"1:669471957796:web:5d69121f9a74e696fb49b1", measurementId:"G-75TJWFLDSK"};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- DOM ----------
const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");

const ownerPlayerInput = document.getElementById("ownerPlayerInput");
const ownerScoreInput = document.getElementById("ownerScoreInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const deletePlayerBtn = document.getElementById("deletePlayerBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const announcementInput = document.getElementById("announcementInput");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");
const ownerManageInput = document.getElementById("ownerManageInput");
const giveOwnerBtn = document.getElementById("giveOwnerBtn");
const removeOwnerBtn = document.getElementById("removeOwnerBtn");
const timerInput = document.getElementById("timerInput");
const timerMessageInput = document.getElementById("timerMessageInput");
const startTimerBtn = document.getElementById("startTimerBtn");

// ---------- CANVAS ----------
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

// ---------- GAME STATE ----------
let username = localStorage.getItem("snake_username") || "";
let snake, food, score;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop=null;
let alive = true;
let owners = ["PatronMo"];
let autoCollect=false;
let autoCollectLoop=null;

// ---------- FUNCTIONS ----------
function showAnnouncement(msg){ 
  const popup=document.getElementById("announcementPopup");
  popup.textContent=msg; popup.style.display="block";
  setTimeout(()=>popup.style.display="none",3000);
}

function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }

function resetGame(){ 
  snake=[{x:8*box,y:10*box},{x:9*box,y:10*box},{x:10*box,y:10*box}];
  direction="RIGHT"; nextDirection="RIGHT"; score=0; alive=true; food=spawnFood(); 
  scoreDisplay.textContent=score; deathText.classList.add("hidden"); 
  clearInterval(loop); loop=setInterval(draw,70); 
}

function draw(){
  if(!alive) return;
  direction=nextDirection;
  ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="red"; ctx.fillRect(food.x,food.y,box,box);
  snake.forEach((s,i)=>{ ctx.fillStyle=i===0?"#0f0":"#0c0"; ctx.fillRect(s.x,s.y,box,box); });
  let head={...snake[0]};
  if(direction==="LEFT") head.x-=box; if(direction==="RIGHT") head.x+=box; if(direction==="UP") head.y-=box; if(direction==="DOWN") head.y+=box;
  if(head.x<0 || head.y<0 || head.x>=canvas.width || head.y>=canvas.height || snake.slice(1).some(s=>s.x===head.x && s.y===head.y)){
    alive=false; clearInterval(loop); deathText.classList.remove("hidden"); return; 
  }
  if(head.x===food.x && head.y===food.y){ score++; scoreDisplay.textContent=score; snake.unshift(head); food=spawnFood(); }
  else snake.pop(), snake.unshift(head);
}

// ---------- INPUT ----------
document.addEventListener("keydown", e=>{
  if(!alive && e.code==="Space"){ resetGame(); e.preventDefault(); }
  if(e.key==="ArrowLeft"||e.key==="a") if(direction!=="RIGHT") nextDirection="LEFT";
  if(e.key==="ArrowUp"||e.key==="w") if(direction!=="DOWN") nextDirection="UP";
  if(e.key==="ArrowRight"||e.key==="d") if(direction!=="LEFT") nextDirection="RIGHT";
  if(e.key==="ArrowDown"||e.key==="s") if(direction!=="UP") nextDirection="DOWN";
});

// ---------- AUTO-COLLECT SMART ----------
function smartAutoCollect(){
  if(!alive) return;
  const head=snake[0];
  const dx = food.x-head.x;
  const dy = food.y-head.y;
  const moves=[];
  if(dx>0) moves.push("RIGHT"); if(dx<0) moves.push("LEFT");
  if(dy>0) moves.push("DOWN"); if(dy<0) moves.push("UP");
  for(const m of moves){
    const test={...head};
    if(m==="RIGHT") test.x+=box; if(m==="LEFT") test.x-=box; if(m==="DOWN") test.y+=box; if(m==="UP") test.y-=box;
    if(test.x<0||test.y<0||test.x>=canvas.width||test.y>=canvas.height) continue;
    if(snake.some(s=>s.x===test.x && s.y===test.y)) continue;
    nextDirection=m; return;
  }
}
function toggleAutoCollect(enable){
  autoCollect=enable;
  clearInterval(autoCollectLoop);
  if(enable) autoCollectLoop=setInterval(smartAutoCollect,70);
}

// ---------- OWNER PANEL ----------
ownerToggleBtn.addEventListener("click",()=>{ if(owners.includes(username)) ownerPanel.style.display=ownerPanel.style.display==="block"?"none":"block"; else alert("Not owner"); });
function checkOwner(){ return owners.includes(username); }

giveOwnerBtn.addEventListener("click",()=>{ 
  if(!checkOwner()) return alert("Not owner"); 
  const u=ownerManageInput.value.trim(); 
  if(u && !owners.includes(u)){ owners.push(u); alert(u+" is now owner"); } 
});
removeOwnerBtn.addEventListener("click",()=>{ 
  if(!checkOwner()) return alert("Not owner"); 
  const u=ownerManageInput.value.trim(); 
  const i=owners.indexOf(u); if(i!==-1){ owners.splice(i,1); alert(u+" removed from owners"); } 
});

setScoreBtn.addEventListener("click",()=>{ if(!checkOwner()) return alert("Not owner"); const u=ownerPlayerInput.value.trim(); const s=parseInt(ownerScoreInput.value); if(!u||isNaN(s)) return alert("Invalid"); score=s; scoreDisplay.textContent=score; });
deletePlayerBtn.addEventListener("click",()=>{ if(!checkOwner()) return alert("Not owner"); const u=ownerPlayerInput.value.trim(); if(!u) return alert("Enter username"); alert(u+" removed from leaderboard (simulated)"); });
clearChatBtn.addEventListener("click",()=>{ if(!checkOwner()) return alert("Not owner"); chatBox.innerHTML=""; });
sendAnnouncementBtn.addEventListener("click",()=>{ if(!checkOwner()) return alert("Not owner"); const m=announcementInput.value.trim(); if(!m) return; showAnnouncement(m); });

// ---------- TIMER FUNCTION ----------
startTimerBtn.addEventListener("click",()=>{
  if(!checkOwner()) return alert("Not owner");
  const t=parseInt(timerInput.value); const msg=timerMessageInput.value.trim();
  if(isNaN(t)||t<=0||!msg) return alert("Invalid input");
  showAnnouncement("Timer started for "+t+"s");
  setTimeout(()=>showAnnouncement(msg), t*1000);
});

// ---------- CHAT ----------
chatSendBtn.addEventListener("click",()=>{ const m=chatInput.value.trim(); if(!m) return; chatBox.innerHTML+=username+": "+m+"<br>"; chatInput.value=""; chatBox.scrollTop=chatBox.scrollHeight; });

// ---------- START ----------
startBtn.addEventListener("click",()=>{
  const u=usernameInput.value.trim(); if(!u) return alert("Enter username");
  username=u; localStorage.setItem("snake_username",username);
  usernameScreen.classList.add("hidden"); gameScreen.classList.remove("hidden");
  playerNameEl.textContent=username;
  resetGame();
});
if(username){ usernameScreen.classList.add("hidden"); gameScreen.classList.remove("hidden"); playerNameEl.textContent=username; resetGame(); }

</script>
</body>
</html>
