<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<style>
/* Je CSS hier */
</style>
</head>
<body>
<div id="usernameScreen">
  <input id="usernameInput" placeholder="Username">
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" style="display:none;">
  <canvas id="game" width="400" height="400"></canvas>
  <p id="scoreDisplay">0</p>
  <p id="playerName"></p>

  <div id="ownerPanel" style="display:none;">
    <input id="ownerPlayerInput" placeholder="Score / Username">
    <button id="setScoreBtn">Add Score</button>
    <button id="deletePlayerBtn">Reset Score</button>
    <button id="clearChatBtn">Clear Chat</button>
    <input id="announcementInput" placeholder="Announcement">
    <button id="sendAnnouncementBtn">Send Announcement</button>
  </div>

  <div id="pollArea"></div>
  <input id="pollQuestionInput" placeholder="Poll Question">
  <input id="pollOptionsInput" placeholder="Option1, Option2,...">
  <button id="createPollBtn">Create Poll</button>
  <button id="closePollBtn">Close Poll</button>

  <button id="toggleAutoCollectBtn">Toggle Auto-Collect</button>
  <div id="announcementPopup"></div>
  <div id="chatBox"></div>
  <input id="chatInput">
  <button id="chatSendBtn">Send</button>
  <button id="toggleChatBtn">Toggle Chat</button>
</div>

<script>
// ---------------- DOM -----------------
const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const leaderboard = document.getElementById("leaderboard");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const toggleChatBtn = document.getElementById("toggleChatBtn");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");
const pollArea = document.getElementById("pollArea");
const ownerPlayerInput = document.getElementById("ownerPlayerInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const deletePlayerBtn = document.getElementById("deletePlayerBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const announcementInput = document.getElementById("announcementInput");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");
const pollQuestionInput = document.getElementById("pollQuestionInput");
const pollOptionsInput = document.getElementById("pollOptionsInput");
const createPollBtn = document.getElementById("createPollBtn");
const closePollBtn = document.getElementById("closePollBtn");
const toggleAutoCollectBtn = document.getElementById("toggleAutoCollectBtn");

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

// ---------------- STATE -----------------
let username = localStorage.getItem("snake_username") || "";
let snake, food, score, direction, nextDirection, loop, alive;
let autoCollect = false;
let chatEnabled = true;
let poll = null;
let autoCollectInterval;

// ---------------- UTILS -----------------
function isOwner(){ return username === "PatronMo"; }
function showAnnouncement(msg){
    const popup = document.getElementById("announcementPopup");
    popup.textContent = msg;
    popup.style.display="block";
    setTimeout(()=>popup.style.display="none",2000);
}
function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }
function updateLeaderboard(){ leaderboard.innerHTML=`<li>${username}: ${score}</li>`; }

// ---------------- GAME -----------------
function resetGame(){
    snake=[{x:10*box,y:10*box}];
    direction="RIGHT"; nextDirection="RIGHT";
    score=0; alive=true;
    food=spawnFood();
    scoreDisplay.textContent=score;
    clearInterval(loop);
    loop=setInterval(draw,100);
}

function draw(){
    direction = nextDirection;
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw food
    ctx.fillStyle="red";
    ctx.beginPath();
    ctx.arc(food.x+box/2, food.y+box/2, box/2, 0, Math.PI*2);
    ctx.fill();
    ctx.closePath();

    // draw snake
    snake.forEach((s,i)=>{
        ctx.beginPath();
        ctx.fillStyle = i===0 ? "#00ff66" : "#00cc55";
        ctx.arc(s.x+box/2, s.y+box/2, box/2, 0, Math.PI*2);
        ctx.fill();
        ctx.closePath();
    });

    // move snake
    let head = {...snake[0]};
    if(direction==="LEFT") head.x-=box;
    if(direction==="RIGHT") head.x+=box;
    if(direction==="UP") head.y-=box;
    if(direction==="DOWN") head.y+=box;

    // collision
    if(head.x<0||head.x>=canvas.width||head.y<0||snake.some(s=>s.x===head.x&&s.y===head.y)){
        alive=false;
        clearInterval(loop);
        return;
    }

    // eat food
    if(head.x===food.x && head.y===food.y){
        score++; scoreDisplay.textContent=score;
        snake.unshift(head);
        food = spawnFood();
    } else {
        snake.pop();
        snake.unshift(head);
    }

    updateLeaderboard();
}

// ---------------- INPUT -----------------
document.addEventListener("keydown", e=>{
    if(!alive && e.code==="Space"){ resetGame(); }
    if(e.key==="ArrowLeft" && direction!=="RIGHT") nextDirection="LEFT";
    if(e.key==="ArrowRight" && direction!=="LEFT") nextDirection="RIGHT";
    if(e.key==="ArrowUp" && direction!=="DOWN") nextDirection="UP";
    if(e.key==="ArrowDown" && direction!=="UP") nextDirection="DOWN";
});

// ---------------- OWNER PANEL -----------------
ownerToggleBtn.addEventListener("click", ()=>{
    if(!isOwner()){ alert("Not owner"); return; }
    ownerPanel.style.display = ownerPanel.style.display==="block" ? "none":"block";
});

// ---------------- CHAT -----------------
toggleChatBtn.addEventListener("click", ()=>{
    if(!isOwner()){ alert("Not owner"); return; }
    chatEnabled = !chatEnabled;
    chatBox.style.display = chatEnabled ? "block":"none";
    chatInput.style.display = chatEnabled ? "inline":"none";
});

chatSendBtn.addEventListener("click", ()=>{
    if(!chatEnabled) return;
    const msg = chatInput.value.trim();
    if(!msg) return;
    const div = document.createElement("div");
    div.textContent = username+": "+msg;
    chatBox.appendChild(div);
    chatInput.value="";
    chatBox.scrollTop = chatBox.scrollHeight;
});

clearChatBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    chatBox.innerHTML="";
});

sendAnnouncementBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    const msg = announcementInput.value.trim();
    if(!msg) return;
    const div = document.createElement("div");
    div.textContent = "ðŸŒŸ Announcement: "+msg;
    chatBox.appendChild(div);
    announcementInput.value="";
});

// ---------------- POLL -----------------
createPollBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    const q = pollQuestionInput.value.trim();
    const opts = pollOptionsInput.value.split(",").map(x=>x.trim()).filter(x=>x);
    if(!q || opts.length<2) return alert("Enter question + 2 options");
    poll = {question:q, options:opts, votes:{}, open:true};
    renderPoll();
});

closePollBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    if(poll) poll.open=false;
    renderPoll();
});

function renderPoll(){
    pollArea.innerHTML="";
    if(!poll){ pollArea.innerHTML="<i>No active poll</i>"; return; }
    pollArea.innerHTML=`<b>${poll.question}</b><br>`;
    poll.options.forEach(opt=>{
        const btn = document.createElement("button");
        const count = Object.values(poll.votes).filter(v=>v===opt).length;
        btn.textContent = `${opt} (${count} votes)`;
        btn.disabled = !poll.open || poll.votes[username];
        btn.onclick = ()=>{ poll.votes[username] = opt; renderPoll(); };
        pollArea.appendChild(btn);
        pollArea.appendChild(document.createElement("br"));
    });
    if(!poll.open) pollArea.innerHTML+="<i>Poll closed</i>";
}

// ---------------- AUTO-COLLECT -----------------
toggleAutoCollectBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    autoCollect = !autoCollect;
    showAnnouncement("Auto-Collect "+(autoCollect?"Enabled":"Disabled"));
    if(autoCollect){
        if(autoCollectInterval) clearInterval(autoCollectInterval);
        autoCollectInterval = setInterval(()=>{ if(alive) autoMove(); }, 100);
    } else clearInterval(autoCollectInterval);
});

function autoMove(){
    if(!alive) return;
    let head = snake[0];
    if(head.x < food.x && direction!=="LEFT") nextDirection="RIGHT";
    else if(head.x > food.x && direction!=="RIGHT") nextDirection="LEFT";
    else if(head.y < food.y && direction!=="UP") nextDirection="DOWN";
    else if(head.y > food.y && direction!=="DOWN") nextDirection="UP";
}

// ---------------- SCORE ADJUST -----------------
setScoreBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    const val = parseInt(ownerPlayerInput.value);
    if(isNaN(val) || val <=0) return alert("Invalid");
    score += val;
    scoreDisplay.textContent = score;
});

deletePlayerBtn.addEventListener("click", ()=>{
    if(!isOwner()) return;
    score = 0;
    scoreDisplay.textContent = score;
});

// ---------------- START -----------------
startBtn.addEventListener("click", ()=>{
    const val = usernameInput.value.trim();
    if(!val) return alert("Enter username");
    username = val;
    localStorage.setItem("snake_username", username);
    usernameScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
    playerNameEl.textContent=username;
    resetGame();
});

// ---------------- AUTO START -----------------
if(username){
    usernameScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
    playerNameEl.textContent=username;
    resetGame();
}

</script>
</body>
</html>
