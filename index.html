<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0; background:#0f0f0f; color:white; font-family:Arial,sans-serif; text-align:center; overflow-y:auto;}
canvas {background:#000; border:3px solid #00ff66; display:block; margin:10px auto;}
.hidden {display:none;}
.score {font-size:18px; margin:4px 0;}
.best {color:gold;}
#chatBox {max-height:200px; overflow-y:auto; background:#111; border:2px solid #00ff66; padding:5px; margin:10px auto; width:90%; max-width:400px; text-align:left;}
#chatInput {width:65%; padding:5px;}
button {padding:5px 10px; cursor:pointer;}
#ownerPanel {display:none; margin:10px auto; border:2px solid red; padding:10px; width:90%; max-width:400px; text-align:left; background:#222;}
#madeBy {position:absolute; top:5px; left:5px; color:#00ff66; font-weight:bold;}
#announcementPopup {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#ff0; color:#000; padding:10px 20px; font-weight:bold; border-radius:5px; display:none; z-index:1000;}
#ownerToggleBtn {position:fixed; bottom:10px; right:10px; background:red; color:white; font-weight:bold; border:none; border-radius:5px; padding:10px; cursor:pointer;}
#pollArea button {margin:2px;}
#abilityTimerDisplay {margin:5px 0; font-weight:bold; color:#0ff;}
</style>
</head>
<body>
<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<h1>üêç Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>
  <p class="score">Score: <strong id="scoreDisplay">0</strong> | Best: <strong id="bestDisplay">0</strong></p>
  <canvas id="game" width="400" height="400"></canvas>
  <p id="deathText" class="hidden">üíÄ You died ‚Äî press <b>SPACE</b> to respawn</p>

  <h3>üèÜ Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <h3>üí¨ Global Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button id="chatSendBtn">Send</button>
  <button id="toggleChatBtn">Toggle Chat (Owner)</button>

  <h3>üìä Live Poll</h3>
  <div id="pollArea"></div>

  <h3>‚è± Global Ability</h3>
  <div id="abilityTimerDisplay">Inactive</div>

  <div id="ownerPanel">
    <h3>üõ† Owner Panel</h3>
    <div>
      <h4>üíØ Adjust Scores</h4>
      <input id="ownerPlayerInput" placeholder="Score amount">
      <button id="setScoreBtn">Add Score</button>
      <button id="deletePlayerBtn">Reset Score</button>
    </div>
    <div>
      <h4>üí¨ Chat Management</h4>
      <button id="clearChatBtn">Clear Chat</button>
      <input id="announcementInput" placeholder="Announcement">
      <button id="sendAnnouncementBtn">Send Announcement</button>
    </div>
    <div>
      <h4>üìä Poll Controls</h4>
      <input id="pollQuestionInput" placeholder="Question">
      <input id="pollOptionsInput" placeholder="Options comma-separated">
      <button id="createPollBtn">Create Poll</button>
      <button id="closePollBtn">Close Poll</button>
    </div>
    <div>
      <h4>üí• Abilities</h4>
      <button id="activateAbilityBtn">Surprise Ability</button>
      <button id="toggleAutoCollectBtn">Toggle Auto-Collect</button>
    </div>
  </div>
</div>

<button id="ownerToggleBtn">√ó</button>

<script>
const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const bestDisplay = document.getElementById("bestDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const toggleChatBtn = document.getElementById("toggleChatBtn");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");
const pollArea = document.getElementById("pollArea");
const abilityTimerDisplay = document.getElementById("abilityTimerDisplay");
const ownerPlayerInput = document.getElementById("ownerPlayerInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const deletePlayerBtn = document.getElementById("deletePlayerBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const announcementInput = document.getElementById("announcementInput");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");
const pollQuestionInput = document.getElementById("pollQuestionInput");
const pollOptionsInput = document.getElementById("pollOptionsInput");
const createPollBtn = document.getElementById("createPollBtn");
const closePollBtn = document.getElementById("closePollBtn");
const activateAbilityBtn = document.getElementById("activateAbilityBtn");
const toggleAutoCollectBtn = document.getElementById("toggleAutoCollectBtn");

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

let username = localStorage.getItem("snake_username") || "";
let snake, food, score, direction, nextDirection, loop, alive;
let autoCollect = false;
let chatEnabled = true;
let poll = null;

// ---------------- UTILITY -----------------
function showAnnouncement(msg){
    const popup = document.getElementById("announcementPopup");
    popup.textContent = msg;
    popup.style.display="block";
    setTimeout(()=>popup.style.display="none",2000);
}
function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }
function updateLeaderboard(){
    leaderboard.innerHTML=`<li>${username}: ${score}</li>`;
}

// ---------------- SNAKE -----------------
function resetGame(){
    snake=[{x:10*box,y:10*box}];
    direction="RIGHT"; nextDirection="RIGHT";
    score=0; alive=true;
    food=spawnFood();
    scoreDisplay.textContent=0;
    deathText.classList.add("hidden");
    clearInterval(loop);
    loop=setInterval(draw,100);
}

function draw(){
    direction = nextDirection;
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    // draw food
    ctx.fillStyle="red";
    ctx.beginPath();
    ctx.arc(food.x+box/2,food.y+box/2,box/2,0,Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // draw snake
    snake.forEach((s,i)=>{
        ctx.beginPath();
        ctx.fillStyle = i===0 ? "#00ff66" : "#00cc55";
        ctx.arc(s.x+box/2,s.y+box/2,box/2,0,Math.PI*2);
        ctx.fill();
        ctx.closePath();
    });
    // move snake
    let head={...snake[0]};
    if(direction==="LEFT") head.x-=box;
    if(direction==="RIGHT") head.x+=box;
    if(direction==="UP") head.y-=box;
    if(direction==="DOWN") head.y+=box;
    // collision
    if(head.x<0||head.x>=canvas.width||head.y<0||snake.some(s=>s.x===head.x&&s.y===head.y)){
        alive=false;
        clearInterval(loop);
        deathText.classList.remove("hidden");
        return;
    }
    // eat food
    if(head.x===food.x&&head.y===food.y){
        score++; scoreDisplay.textContent=score;
        snake.unshift(head);
        food=spawnFood();
    } else {
        snake.pop();
        snake.unshift(head);
    }
    updateLeaderboard();
}

// ---------------- INPUT -----------------
document.addEventListener("keydown",e=>{
    if(!alive && e.code==="Space"){ resetGame(); }
    if(e.key==="ArrowLeft") if(direction!=="RIGHT") nextDirection="LEFT";
    if(e.key==="ArrowRight") if(direction!=="LEFT") nextDirection="RIGHT";
    if(e.key==="ArrowUp") if(direction!=="DOWN") nextDirection="UP";
    if(e.key==="ArrowDown") if(direction!=="UP") nextDirection="DOWN";
});

// ---------------- OWNER PANEL -----------------
function isOwner(){ return username==="PatronMo"; }

ownerToggleBtn.addEventListener("click",()=>{
    if(!isOwner()){ alert("Not owner"); return; }
    ownerPanel.style.display = ownerPanel.style.display==="block" ? "none":"block";
});

// chat toggle
toggleChatBtn.addEventListener("click",()=>{
    if(!isOwner()){ alert("Not owner"); return; }
    chatEnabled=!chatEnabled;
    chatBox.style.display=chatEnabled?"block":"none";
    chatInput.style.display=chatEnabled?"inline":"none";
});

// chat send
chatSendBtn.addEventListener("click",()=>{
    if(!chatEnabled) return;
    const msg = chatInput.value.trim();
    if(!msg) return;
    const div = document.createElement("div");
    div.textContent=username+": "+msg;
    chatBox.appendChild(div);
    chatInput.value="";
    chatBox.scrollTop=chatBox.scrollHeight;
});

// score adjust
setScoreBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    const val = parseInt(ownerPlayerInput.value);
    if(isNaN(val)||val<=0) return alert("Invalid");
    for(let i=0;i<val;i++) snake.push({...snake[snake.length-1]});
    score+=val; scoreDisplay.textContent=score;
});

// reset score
deletePlayerBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    snake=[{x:10*box,y:10*box}]; score=0; scoreDisplay.textContent=score;
});

// ---------------- POLL -----------------
createPollBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    const q=pollQuestionInput.value.trim();
    const opts=pollOptionsInput.value.split(",").map(x=>x.trim()).filter(x=>x);
    if(!q||opts.length<2) return alert("Enter question + 2 options");
    poll={question:q, options:opts, votes:{}, open:true};
    renderPoll();
});
closePollBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    if(poll) poll.open=false;
    renderPoll();
});

function renderPoll(){
    pollArea.innerHTML="";
    if(!poll){ pollArea.innerHTML="<i>No active poll</i>"; return; }
    pollArea.innerHTML=`<b>${poll.question}</b><br>`;
    poll.options.forEach(opt=>{
        const btn=document.createElement("button");
        const count = Object.values(poll.votes).filter(v=>v===opt).length;
        btn.textContent=`${opt} (${count} votes)`;
        btn.disabled=!poll.open || poll.votes[username];
        btn.onclick=()=>{ poll.votes[username]=opt; renderPoll(); };
        pollArea.appendChild(btn);
        pollArea.appendChild(document.createElement("br"));
    });
    if(!poll.open) pollArea.innerHTML+="<i>Poll closed</i>";
}

// ---------------- AUTO-COLLECT -----------------
toggleAutoCollectBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    autoCollect=!autoCollect;
    showAnnouncement("Auto-Collect "+(autoCollect?"Enabled":"Disabled"));
    if(autoCollect){
        if(autoCollectInterval) clearInterval(autoCollectInterval);
        autoCollectInterval=setInterval(()=>{if(alive) autoMove();},100);
    } else clearInterval(autoCollectInterval);
});

function autoMove(){
    if(!alive) return;
    let head = snake[0];
    if(head.x<food.x && direction!=="LEFT") nextDirection="RIGHT";
    else if(head.x>food.x && direction!=="RIGHT") nextDirection="LEFT";
    else if(head.y<food.y && direction!=="UP") nextDirection="DOWN";
    else if(head.y>food.y && direction!=="DOWN") nextDirection="UP";
}

// ---------------- SURPRISE ABILITY -----------------
activateAbilityBtn.addEventListener("click",()=>{
    if(!isOwner()) return alert("Not owner");
    showAnnouncement("‚ú® Surprise! Your snake glows! ‚ú®");
    snake.forEach(s=>s.glow=true);
    setTimeout(()=>snake.forEach(s=>s.glow=false),5000);
});

// ---------------- START -----------------
startBtn.addEventListener("click",()=>{
    const val=usernameInput.value.trim();
    if(!val) return alert("Enter username");
    username=val;
    localStorage.setItem("snake_username",username);
    usernameScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
    playerNameEl.textContent=username;
    resetGame();
});

// ---------------- AUTO START -----------------
if(username){
    usernameScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
    playerNameEl.textContent=username;
    resetGame();
}
</script>
</body>
</html>
