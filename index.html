<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0; background:#0f0f0f; color:white; font-family:Arial,sans-serif; text-align:center; overflow-y:auto;}
canvas {background:#000; border:3px solid #00ff66; display:block; margin:10px auto;}
.hidden {display:none;}
.score {font-size:18px; margin:4px 0;}
.best {color:gold; transition:transform 0.2s;}
.best.flash {animation: bestFlash 0.4s ease;}
@keyframes bestFlash {0% {transform:scale(1); color:gold;} 50% {transform:scale(1.3); color:#fff176;} 100% {transform:scale(1); color:gold;}}
.score-pop {position:absolute; color:#00ff66; font-weight:bold; pointer-events:none; animation:pop 0.6s ease-out forwards;}
@keyframes pop {0% {opacity:1; transform:translateY(0) scale(1);} 100% {opacity:0; transform:translateY(-25px) scale(1.4);}}
#chatBox {max-height:250px; overflow-y:auto; background:#111; border:2px solid #00ff66; padding:5px; margin:10px auto; width:90%; max-width:400px; text-align:left;}
#chatInput {width:65%; padding:5px;}
button {padding:5px 10px; cursor:pointer;}
#ownerPanel {display:none; margin:10px auto; border:2px solid red; padding:10px; width:90%; max-width:400px; text-align:left; background:#222;}
#madeBy {position:absolute; top:5px; left:5px; color:#00ff66; font-weight:bold;}
#announcementPopup {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#ff0; color:#000; padding:10px 20px; font-weight:bold; border-radius:5px; display:none; z-index:1000;}
#ownerToggleBtn {position:fixed; bottom:10px; right:10px; background:red; color:white; font-weight:bold; border:none; border-radius:5px; padding:10px; cursor:pointer;}
#pollArea button {margin:2px;}
#abilityTimerDisplay {margin:5px 0; font-weight:bold; color:#0ff;}
</style>
</head>
<body>
<div id="madeBy">Made by PatronMo</div>
<div id="announcementPopup"></div>

<h1>üêç Snake</h1>

<div id="usernameScreen">
  <p>Choose a username (cannot be changed)</p>
  <input id="usernameInput" maxlength="12" placeholder="Username">
  <br>
  <button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
  <p>Player: <strong id="playerName"></strong></p>
  <p class="score">Score: <strong id="scoreDisplay">0</strong> | Best: <strong id="bestDisplay" class="best">0</strong></p>
  <canvas id="game" width="400" height="400"></canvas>
  <p id="deathText" class="hidden">üíÄ You died ‚Äî press <b>SPACE</b> to respawn</p>

  <h3>üèÜ Leaderboard</h3>
  <ol id="leaderboard"></ol>

  <h3>üí¨ Global Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button id="chatSendBtn">Send</button>

  <h3>üìä Live Poll</h3>
  <div id="pollArea"></div>

  <h3>‚è± Global Ability</h3>
  <div id="abilityTimerDisplay">Inactive</div>

  <div id="ownerPanel">
    <h3>üõ† Owner Panel</h3>
    <div>
      <h4>üíØ Adjust Scores</h4>
      <input id="ownerPlayerInput" placeholder="Username">
      <input id="ownerScoreInput" type="number" placeholder="Score">
      <button id="setScoreBtn">Set Score</button>
      <button id="deletePlayerBtn">Delete Player</button>
    </div>
    <div>
      <h4>üí¨ Chat Management</h4>
      <button id="clearChatBtn">Clear Chat</button>
      <input id="announcementInput" placeholder="Announcement">
      <button id="sendAnnouncementBtn">Send Announcement</button>
    </div>
    <div>
      <h4>üëë Owner Management</h4>
      <input id="ownerManageInput" placeholder="Username">
      <button id="giveOwnerBtn">Give Owner</button>
      <button id="removeOwnerBtn">Remove Owner</button>
    </div>
    <div>
      <h4>üï∂ Invisibility</h4>
      <button id="toggleInvisibleBtn">Toggle Invisibility</button>
    </div>
    <div>
      <h4>üìä Poll Controls</h4>
      <input id="pollQuestionInput" placeholder="Question">
      <input id="pollOptionsInput" placeholder="Options comma-separated">
      <button id="createPollBtn">Create Poll</button>
      <button id="closePollBtn">Close Poll</button>
    </div>
    <div>
      <h4>üí• Global Ability</h4>
      <button id="activateAbilityBtn">Activate Ability</button>
    </div>
  </div>
</div>

<button id="ownerToggleBtn">√ó</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYOMwhe0SpsEucCwB-cLyiPu6d6GPKWJo",
  authDomain: "snake-game-5205d.firebaseapp.com",
  projectId: "snake-game-5205d",
  storageBucket: "snake-game-5205d.firebasestorage.app",
  messagingSenderId: "669471957796",
  appId: "1:669471957796:web:5d69121f9a74e696fb49b1",
  measurementId: "G-75TJWFLDSK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM Elements
const usernameScreen = document.getElementById("usernameScreen");
const gameScreen = document.getElementById("gameScreen");
const usernameInput = document.getElementById("usernameInput");
const startBtn = document.getElementById("startBtn");
const playerNameEl = document.getElementById("playerName");
const scoreDisplay = document.getElementById("scoreDisplay");
const bestDisplay = document.getElementById("bestDisplay");
const deathText = document.getElementById("deathText");
const leaderboard = document.getElementById("leaderboard");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");
const ownerPanel = document.getElementById("ownerPanel");
const ownerToggleBtn = document.getElementById("ownerToggleBtn");
const pollArea = document.getElementById("pollArea");
const abilityTimerDisplay = document.getElementById("abilityTimerDisplay");

// Owner panel elements
const ownerPlayerInput = document.getElementById("ownerPlayerInput");
const ownerScoreInput = document.getElementById("ownerScoreInput");
const setScoreBtn = document.getElementById("setScoreBtn");
const deletePlayerBtn = document.getElementById("deletePlayerBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const announcementInput = document.getElementById("announcementInput");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");
const ownerManageInput = document.getElementById("ownerManageInput");
const giveOwnerBtn = document.getElementById("giveOwnerBtn");
const removeOwnerBtn = document.getElementById("removeOwnerBtn");
const toggleInvisibleBtn = document.getElementById("toggleInvisibleBtn");
const pollQuestionInput = document.getElementById("pollQuestionInput");
const pollOptionsInput = document.getElementById("pollOptionsInput");
const createPollBtn = document.getElementById("createPollBtn");
const closePollBtn = document.getElementById("closePollBtn");
const activateAbilityBtn = document.getElementById("activateAbilityBtn");

// Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;

// Game state
let username = localStorage.getItem("snake_username") || "";
let snake, food, score;
let direction = "RIGHT";
let nextDirection = "RIGHT";
let loop = null;
let alive = true;
let invisible = false;
let abilityTimer = null;
let abilityEndTime = null;

// ---------------- FUNCTIONS ----------------
function showAnnouncement(msg){ 
  const announcementPopup = document.getElementById("announcementPopup");
  announcementPopup.textContent = msg; 
  announcementPopup.style.display = "block"; 
  setTimeout(()=>announcementPopup.style.display="none",3000); 
}

// ---------------- SNAKE ----------------
function spawnFood(){ return {x:Math.floor(Math.random()*20)*box, y:Math.floor(Math.random()*20)*box}; }
function scorePop(x,y){ const pop=document.createElement("div"); pop.className="score-pop"; pop.textContent="+1"; pop.style.left=canvas.offsetLeft+x+"px"; pop.style.top=canvas.offsetTop+y+"px"; document.body.appendChild(pop); setTimeout(()=>pop.remove(),600); }
function gameOver(){ if(invisible) return; alive=false; clearInterval(loop); setDoc(doc(db,"scores",username),{score:score}); deathText.classList.remove("hidden"); updateLeaderboard(); }
function resetGame(){ snake=[{x:10*box,y:10*box},{x:9*box,y:10*box},{x:8*box,y:10*box}]; direction="RIGHT"; nextDirection="RIGHT"; score=0; alive=true; food=spawnFood(); scoreDisplay.textContent=0; deathText.classList.add("hidden"); clearInterval(loop); loop=setInterval(draw,70); }
function draw(){ direction=nextDirection; ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height); snake.forEach((s,i)=>{ ctx.fillStyle=i===0?"#00ff66":"#00cc55"; ctx.fillRect(s.x,s.y,box,box); }); ctx.fillStyle="red"; ctx.fillRect(food.x,food.y,box,box); let head={...snake[0]}; if(direction==="LEFT") head.x-=box; if(direction==="RIGHT") head.x+=box; if(direction==="UP") head.y-=box; if(direction==="DOWN") head.y+=box; if(!invisible && (head.x<0 || head.y<0 || head.x>=canvas.width || head.y>=canvas.height || snake.some(s=>s.x===head.x && s.y===head.y))){ return gameOver(); } if(head.x===food.x && head.y===food.y){ score++; scoreDisplay.textContent=score; scorePop(head.x,head.y); food=spawnFood(); } else snake.pop(); snake.unshift(head); }

// ---------------- LEADERBOARD ----------------
async function updateLeaderboard(){
  leaderboard.innerHTML="";
  const q=query(collection(db,"scores"),orderBy("score","desc"),limit(10));
  const snapshot=await getDocs(q);
  snapshot.forEach(doc=>{ const li=document.createElement("li"); li.textContent=`${doc.id}: ${doc.data().score}`; leaderboard.appendChild(li); });
}

// ---------------- CHAT ----------------
async function sendMessage(){ const text=chatInput.value.trim(); if(!text) return; await addDoc(collection(db,"chatMessages"),{username,message:text,timestamp:Date.now()}); chatInput.value=""; chatInput.focus(); }
chatSendBtn.addEventListener("click",sendMessage);
chatInput.addEventListener("keydown",e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }});

// Real-time chat
const chatQuery=query(collection(db,"chatMessages"),orderBy("timestamp","asc"),limit(50));
onSnapshot(chatQuery,snapshot=>{
  chatBox.innerHTML="";
  snapshot.forEach(doc=>{
    const m=doc.data();
    const div=document.createElement("div");
    div.textContent=`${m.username}: ${m.message}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
});

// ---------------- OWNER PANEL ----------------
ownerToggleBtn.addEventListener("click", ()=>{
  if(ownerPanel.style.display==="block"){ ownerPanel.style.display="none"; return; }
  if(username==="PatronMo"){ ownerPanel.style.display="block"; } else alert("You are not an owner");
});

async function checkOwnerAction(){ if(username!=="PatronMo"){ alert("Not allowed"); return false; } return true; }

// Owner actions
giveOwnerBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; alert(ownerManageInput.value+" is now an owner (simulated)"); });
removeOwnerBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; alert(ownerManageInput.value+" removed from owner (simulated)"); });
setScoreBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; const user=ownerPlayerInput.value.trim(); const sc=parseInt(ownerScoreInput.value); if(!user||isNaN(sc)) return alert("Invalid input"); await setDoc(doc(db,"scores",user),{score:sc}); alert(user+"'s score set to "+sc); updateLeaderboard(); });
deletePlayerBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; const user=ownerPlayerInput.value.trim(); if(!user) return alert("Enter username"); await deleteDoc(doc(db,"scores",user)); alert(user+" removed"); updateLeaderboard(); });
clearChatBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; const snapshot=await getDocs(collection(db,"chatMessages")); snapshot.forEach(doc=>deleteDoc(doc.ref)); });
sendAnnouncementBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; const msg=announcementInput.value.trim(); if(!msg) return; await addDoc(collection(db,"chatMessages"),{username:"üåü Announcement", message:msg, timestamp:Date.now()}); announcementInput.value=""; });

// ---------------- INVISIBILITY ----------------
function setInvisibility(durationSec, endMsg){ invisible=true; if(abilityTimer) clearTimeout(abilityTimer); setTimeout(()=>{ invisible=false; showAnnouncement(endMsg||"Invisibility ended!"); }, durationSec*1000); showAnnouncement("You are invisible for "+durationSec+" seconds!"); }
toggleInvisibleBtn.addEventListener("click", async ()=>{ if(!(await checkOwnerAction())) return; const dur=prompt("Enter invisibility duration (seconds):"); if(!dur||isNaN(dur)) return; const msg=prompt("Enter message when invisibility ends:","Invisibility ended!"); setInvisibility(parseInt(dur), msg); });

// ---------------- POLL ----------------
const pollDoc = doc(db,"polls","currentPoll");
createPollBtn.addEventListener("click", async ()=>{
  if(!(await checkOwnerAction())) return;
  const question=pollQuestionInput.value.trim();
  const options=pollOptionsInput.value.trim().split(",").map(o=>o.trim()).filter(o=>o);
  if(!question||options.length<2) return alert("Enter question and at least 2 options");
  await setDoc(pollDoc,{question, options, votes:{}, open:true});
  pollQuestionInput.value=""; pollOptionsInput.value="";
});
closePollBtn.addEventListener("click", async()=>{ if(!(await checkOwnerAction())) return; await setDoc(pollDoc,{open:false},{merge:true}); });

onSnapshot(pollDoc,snapshot=>{
  const data=snapshot.data();
  if(!data){ pollArea.innerHTML="<i>No active poll</i>"; return; }
  pollArea.innerHTML=`<b>${data.question}</b><br>`;
  const votes=data.votes||{};
  const totalVotes=Object.keys(votes).length;
  data.options.forEach(opt=>{
    const count=Object.values(votes).filter(v=>v===opt).length;
    const percent=totalVotes? Math.round((count/totalVotes)*100):0;
    const btn=document.createElement("button");
    btn.textContent=`${opt} (${count} votes / ${percent}%)`;
    btn.disabled=!data.open || votes[username];
    btn.onclick=async()=>{ votes[username]=opt; await setDoc(pollDoc,{votes},{merge:true}); };
    pollArea.appendChild(btn);
    pollArea.appendChild(document.createElement("br"));
  });
  if(!data.open) pollArea.innerHTML+="<i>Poll closed</i>";
});

// ---------------- GLOBAL ABILITY TIMER ----------------
activateAbilityBtn.addEventListener("click", async()=>{
  if(!(await checkOwnerAction())) return;
  const dur = parseInt(prompt("Enter ability duration (seconds):"));
  if(isNaN(dur) || dur <=0) return alert("Invalid duration");
  const msg = prompt("Enter message when ability ends:","Ability ended!");
  abilityEndTime = Date.now() + dur*1000;
  abilityTimerDisplay.textContent = `Active: ${dur}s remaining`;
  if(abilityTimer) clearInterval(abilityTimer);
  abilityTimer = setInterval(()=>{
    const remaining = Math.max(0, Math.ceil((abilityEndTime - Date.now())/1000));
    abilityTimerDisplay.textContent = remaining>0?`Active: ${remaining}s remaining`:"Inactive";
    if(remaining <=0){
      clearInterval(if(remaining <= 0){
      clearInterval(abilityTimer);
      abilityTimerDisplay.textContent = "Inactive";
      showAnnouncement(msg);
    }
  },1000);
});

// ---------------- START GAME ----------------
startBtn.addEventListener("click", ()=>{
  const input=usernameInput.value.trim();
  if(!input) return alert("Enter a username");
  username=input;
  localStorage.setItem("snake_username",username);
  usernameScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  playerNameEl.textContent=username;
  updateLeaderboard();
  resetGame();
});

// ---------------- INPUT ----------------
document.addEventListener("keydown", e=>{
  if(!alive && e.code==="Space"){ resetGame(); e.preventDefault(); }
  if(e.key==="ArrowLeft"||e.key==="a") if(direction!=="RIGHT") nextDirection="LEFT";
  if(e.key==="ArrowUp"||e.key==="w") if(direction!=="DOWN") nextDirection="UP";
  if(e.key==="ArrowRight"||e.key==="d") if(direction!=="LEFT") nextDirection="RIGHT";
  if(e.key==="ArrowDown"||e.key==="s") if(direction!=="UP") nextDirection="DOWN";
});

// ---------------- AUTO START ----------------
if(username){ usernameScreen.classList.add("hidden"); gameScreen.classList.remove("hidden"); playerNameEl.textContent=username; updateLeaderboard(); resetGame(); }

</script>
</body>
</html>
