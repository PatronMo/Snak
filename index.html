<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0;background:#0f0f0f;color:white;font-family:Arial;text-align:center}
canvas {background:#000;border:3px solid #00ff66;display:block;margin:10px auto}
.hidden{display:none}
#ownerPanel{display:none;background:#222;border:2px solid red;padding:10px;margin:10px auto;width:90%;max-width:420px;text-align:left}
#chatBox{max-height:200px;overflow-y:auto;background:#111;border:2px solid #00ff66;padding:5px;margin:10px auto;width:90%;max-width:420px;text-align:left}
button{cursor:pointer;padding:6px 10px}
#announcementPopup{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#ff0;color:#000;padding:10px 20px;font-weight:bold;border-radius:5px;display:none}
</style>
</head>
<body>

<div id="announcementPopup"></div>

<h1>Snake</h1>

<div id="usernameScreen">
<input id="usernameInput" placeholder="Username">
<button id="startBtn">Start</button>
</div>

<div id="gameScreen" class="hidden">
<p>Player: <strong id="playerName"></strong></p>
<p>Score: <span id="scoreDisplay">0</span></p>

<canvas id="game" width="400" height="400"></canvas>

<h3>Leaderboard</h3>
<ol id="leaderboard"></ol>

<h3>Chat</h3>
<div id="chatBox"></div>
<input id="chatInput">
<button id="chatSendBtn">Send</button>

<div id="ownerPanel">
<h3>Owner Panel</h3>

<input id="ownerUserInput" placeholder="username">
<button id="giveOwnerBtn">Give Owner</button>

<h4>Timer Announcement</h4>
<input id="timerSeconds" placeholder="seconds">
<input id="timerMessage" placeholder="message">
<button id="startTimerBtn">Start Timer</button>

<h4>Auto Collect</h4>
<button id="toggleAutoCollectBtn">Toggle</button>

</div>

<button id="ownerToggleBtn">OWNER</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCYOM...",
authDomain:"snake-game-5205d.firebaseapp.com",
projectId:"snake-game-5205d"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

// DOM
const usernameScreen=document.getElementById("usernameScreen");
const gameScreen=document.getElementById("gameScreen");
const usernameInput=document.getElementById("usernameInput");
const startBtn=document.getElementById("startBtn");
const playerNameEl=document.getElementById("playerName");
const scoreDisplay=document.getElementById("scoreDisplay");
const leaderboard=document.getElementById("leaderboard");
const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatInput");
const chatSendBtn=document.getElementById("chatSendBtn");
const ownerPanel=document.getElementById("ownerPanel");
const ownerToggleBtn=document.getElementById("ownerToggleBtn");
const giveOwnerBtn=document.getElementById("giveOwnerBtn");
const ownerUserInput=document.getElementById("ownerUserInput");
const toggleAutoCollectBtn=document.getElementById("toggleAutoCollectBtn");
const startTimerBtn=document.getElementById("startTimerBtn");
const timerSeconds=document.getElementById("timerSeconds");
const timerMessage=document.getElementById("timerMessage");

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const box=20;

// STATE
let username="";
let snake=[];
let food={};
let score=0;
let direction="RIGHT";
let nextDirection="RIGHT";
let loop;
let alive=true;
let autoCollect=false;
let owners=JSON.parse(localStorage.getItem("owners")||'["PatronMo"]');

// UTILS
function isOwner(){return owners.includes(username);}
function showAnnouncement(msg){
const el=document.getElementById("announcementPopup");
el.textContent=msg;
el.style.display="block";
setTimeout(()=>el.style.display="none",3000);
}

// GAME
function spawnFood(){
return {x:Math.floor(Math.random()*20)*box,y:Math.floor(Math.random()*20)*box};
}

function resetGame(){
snake=[
{x:10*box,y:10*box},
{x:9*box,y:10*box},
{x:8*box,y:10*box}
];
score=0;
direction="RIGHT";
nextDirection="RIGHT";
food=spawnFood();
clearInterval(loop);
loop=setInterval(draw,80);
}

function draw(){
direction=nextDirection;

ctx.fillStyle="black";
ctx.fillRect(0,0,400,400);

// food
ctx.fillStyle="red";
ctx.fillRect(food.x,food.y,box,box);

// snake
snake.forEach((s,i)=>{
ctx.fillStyle=i==0?"#00ff66":"#00aa44";
ctx.fillRect(s.x,s.y,box,box);
});

// move
let head={...snake[0]};
if(direction==="LEFT")head.x-=box;
if(direction==="RIGHT")head.x+=box;
if(direction==="UP")head.y-=box;
if(direction==="DOWN")head.y+=box;

// collision
if(head.x<0||head.y<0||head.x>=400||head.y>=400||snake.some(s=>s.x===head.x&&s.y===head.y)){
alive=false;clearInterval(loop);return;
}

// eat
if(head.x===food.x&&head.y===food.y){
score++;
scoreDisplay.textContent=score;
snake.unshift(head);
food=spawnFood();
saveScore();
}else{
snake.pop();
snake.unshift(head);
}
}

// AUTO COLLECT SMART
function autoMove(){
if(!alive)return;

const head=snake[0];
const dirs=["UP","DOWN","LEFT","RIGHT"];

for(let d of dirs){
let test={...head};
if(d==="LEFT")test.x-=box;
if(d==="RIGHT")test.x+=box;
if(d==="UP")test.y-=box;
if(d==="DOWN")test.y+=box;

if(test.x>=0&&test.y>=0&&test.x<400&&test.y<400&&!snake.some(s=>s.x===test.x&&s.y===test.y)){
nextDirection=d;
break;
}
}
}

toggleAutoCollectBtn.onclick=()=>{
if(!isOwner())return alert("owner only");
autoCollect=!autoCollect;
if(autoCollect)setInterval(autoMove,80);
};

// OWNER PANEL
ownerToggleBtn.onclick=()=>{
if(!isOwner())return alert("not owner");
ownerPanel.style.display=ownerPanel.style.display=="block"?"none":"block";
};

giveOwnerBtn.onclick=()=>{
if(!isOwner())return;
const u=ownerUserInput.value.trim();
if(!u)return;
owners.push(u);
localStorage.setItem("owners",JSON.stringify(owners));
showAnnouncement(u+" is now owner");
};

// TIMER
startTimerBtn.onclick=()=>{
if(!isOwner())return;
const sec=parseInt(timerSeconds.value);
const msg=timerMessage.value;
if(!sec||!msg)return;
showAnnouncement("Timer started");
setTimeout(()=>showAnnouncement(msg),sec*1000);
};

// INPUT
document.addEventListener("keydown",e=>{
if(e.key==="ArrowLeft"&&direction!=="RIGHT")nextDirection="LEFT";
if(e.key==="ArrowRight"&&direction!=="LEFT")nextDirection="RIGHT";
if(e.key==="ArrowUp"&&direction!=="DOWN")nextDirection="UP";
if(e.key==="ArrowDown"&&direction!=="UP")nextDirection="DOWN";
});

// START
startBtn.onclick=()=>{
username=usernameInput.value.trim();
if(!username)return;
usernameScreen.classList.add("hidden");
gameScreen.classList.remove("hidden");
playerNameEl.textContent=username;
resetGame();
};

// FIREBASE
async function saveScore(){
await setDoc(doc(db,"scores",username),{score});
}

const q=query(collection(db,"scores"),orderBy("score","desc"));
onSnapshot(q,snap=>{
leaderboard.innerHTML="";
snap.forEach(d=>{
leaderboard.innerHTML+=`<li>${d.id}: ${d.data().score}</li>`;
});
});

// CHAT
chatSendBtn.onclick=async ()=>{
const msg=chatInput.value;
if(!msg)return;
await addDoc(collection(db,"chat"),{user:username,msg});
chatInput.value="";
};

onSnapshot(collection(db,"chat"),snap=>{
chatBox.innerHTML="";
snap.forEach(d=>{
chatBox.innerHTML+=`<div>${d.data().user}: ${d.data().msg}</div>`;
});
});
</script>
</body>
</html>
